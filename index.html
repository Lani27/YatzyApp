<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yatzy Ultimate</title>
    
    <!-- 1. LOAD FIREBASE "CLASSIC" SCRIPTS (More reliable than Modules) -->
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>

    <style>
        /* --- CSS STYLES --- */
        :root {
            --bg: #121212; --surface: #1e1e1e; --text: #e0e0e0; --text-dim: #a0a0a0;
            --accent: #4caf50; --accent-hover: #43a047; --border: #333;
            --highlight: #2c3e50; --shadow-color: rgba(0,0,0,0.5); --danger: #f44336;
        }
        [data-theme="light"] {
            --bg: #f5f5f5; --surface: #ffffff; --text: #212121; --text-dim: #666;
            --accent: #2196F3; --accent-hover: #1976D2; --border: #ddd;
            --highlight: #e3f2fd; --shadow-color: rgba(0,0,0,0.1);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg); color: var(--text); margin: 0; padding: 15px;
            display: flex; flex-direction: column; align-items: center; transition: background 0.3s, color 0.3s;
        }
        header { width: 100%; max-width: 800px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h1 { margin: 0; font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }
        
        /* Status Dot */
        .status-dot { width: 10px; height: 10px; background-color: #f44336; border-radius: 50%; display: inline-block; transition: background 0.3s; }
        .status-dot.online { background-color: #4caf50; box-shadow: 0 0 0 0 rgba(76, 175, 80, 1); animation: pulse-green 2s infinite; }
        @keyframes pulse-green { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); } }

        .header-actions { display: flex; gap: 10px; }
        .icon-btn { background: none; border: 1px solid var(--border); color: var(--text); padding: 5px 10px; border-radius: 8px; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; }
        
        .controls-area { background: var(--surface); padding: 15px; border-radius: 12px; margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; width: 100%; max-width: 600px; border: 1px solid var(--border); }
        button { background-color: var(--accent); color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.9rem; transition: transform 0.1s; }
        button:active { transform: scale(0.96); }
        button.secondary { background-color: #555; }
        button.danger { background-color: #d32f2f; }
        input[type="text"], input[type="password"] { padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--text); flex-grow: 1; min-width: 120px; }

        .table-wrapper { width: 100%; max-width: 900px; overflow-x: auto; border-radius: 12px; border: 1px solid var(--border); background: var(--surface); position: relative; }
        table { border-collapse: collapse; min-width: 100%; }
        th, td { padding: 8px; text-align: center; border: 1px solid var(--border); white-space: nowrap; }
        th { background-color: var(--surface); position: sticky; top: 0; z-index: 20; cursor: pointer; user-select: none; }
        th.active-player, td.active-col { background-color: var(--highlight) !important; }
        .category-col { position: sticky; left: 0; background-color: var(--surface); z-index: 30; text-align: left; font-weight: bold; width: 130px; border-right: 2px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .table-wrapper.scrolled .category-col { box-shadow: 2px 0 5px var(--shadow-color); }
        .help-icon { font-size: 0.8em; color: var(--text-dim); cursor: help; border: 1px solid var(--border); border-radius: 50%; width: 18px; height: 18px; display: inline-flex; align-items: center; justify-content: center; margin-left: 5px; }
        .subtotal-row { background-color: rgba(255, 255, 255, 0.05); font-weight: bold; color: var(--text-dim); }
        .total-row { background-color: var(--accent); color: white; font-weight: bold; font-size: 1.1em; }
        
        input.score-input { width: 50px; background: transparent; border: none; color: var(--text); text-align: center; font-size: 1.1em; font-weight: 500; padding: 5px 0; }
        input.score-input:focus { background: rgba(255,255,255,0.1); outline: none; border-radius: 4px; }
        input.invalid-shake { color: #f44336; border-bottom: 2px solid #f44336; animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(3px); }
        .modal { background: var(--surface); padding: 25px; border-radius: 12px; width: 90%; max-width: 400px; border: 1px solid var(--border); box-shadow: 0 10px 25px rgba(0,0,0,0.5); text-align: center; }
        .rule-desc { text-align: left; line-height: 1.5; margin: 15px 0; }
        .history-section { margin-top: 30px; width: 100%; max-width: 600px; }
        .history-card { background: var(--surface); padding: 10px 15px; margin-bottom: 10px; border-radius: 8px; border: 1px solid var(--border); display: flex; justify-content: space-between; font-size: 0.9rem; }
        #confetti { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }
        
        /* DEBUG LOG */
        #debug-console {
            width: 100%; background: #000; color: #00ff00; font-family: monospace; font-size: 10px;
            padding: 10px; margin-top: 20px; border-top: 1px solid #333; max-height: 100px; overflow-y: auto;
            display: none;
        }
        .log-err { color: #ff4444; }
        .log-ok { color: #44ff44; }

        /* WINNER OVERLAY */
        #winnerOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 10000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(5px); animation: fadeIn 0.5s;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .winner-content { text-align: center; color: white; animation: zoomBounce 1s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        @keyframes zoomBounce { 0% { transform: scale(0); } 70% { transform: scale(1.2); } 100% { transform: scale(1); } }

        .winner-trophy { font-size: 8rem; margin-bottom: 20px; filter: drop-shadow(0 0 20px gold); animation: float 3s ease-in-out infinite; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-20px); } 100% { transform: translateY(0px); } }

        .winner-title { font-size: 2rem; margin: 0; text-transform: uppercase; letter-spacing: 5px; color: #ffd700; text-shadow: 0 0 10px #ff8c00; }
        .winner-name { font-size: 4rem; font-weight: bold; margin: 10px 0; background: linear-gradient(to right, #ffd700, #ff8c00, #ffd700); -webkit-background-clip: text; color: transparent; background-size: 200% auto; animation: shine 3s linear infinite; }
        @keyframes shine { to { background-position: 200% center; } }

        .winner-score { font-size: 1.5rem; color: #fff; opacity: 0.8; }
        .winner-close-btn { margin-top: 40px; background: transparent; border: 2px solid white; color: white; padding: 10px 30px; font-size: 1.2rem; border-radius: 50px; cursor: pointer; transition: all 0.3s; }
        .winner-close-btn:hover { background: white; color: black; transform: scale(1.1); }

    </style>
</head>
<body>

    <div id="winnerOverlay">
        <div class="winner-content">
            <div class="winner-trophy">üèÜ</div>
            <h2 class="winner-title">Winner</h2>
            <div class="winner-name" id="winnerNameDisplay">Player</div>
            <div class="winner-score" id="winnerScoreDisplay">Score: 100</div>
            <button class="winner-close-btn" onclick="closeWinnerOverlay()">Close</button>
        </div>
    </div>

    <canvas id="confetti"></canvas>

    <header>
        <h1><span id="statusDot" class="status-dot"></span> <span id="appTitle">Yatzy</span></h1>
        <div class="header-actions">
            <button class="icon-btn" id="langBtn" onclick="toggleLanguage()">üá´üáÆ</button>
            <button class="icon-btn" id="soundBtn" onclick="toggleSound()">üîä</button>
            <button class="icon-btn" id="lockBtn" onclick="toggleLockModal()">üîì</button>
            <button class="icon-btn" id="themeBtn" onclick="toggleTheme()">‚òÄÔ∏è</button>
        </div>
    </header>

    <div class="controls-area">
        <input type="text" id="playerName" placeholder="Enter Player Name">
        <button onclick="addPlayer()">+ Add Player</button>
        <button class="secondary" onclick="copyLink()">üîó Share</button>
        <button class="danger" onclick="archiveAndReset()">üèÜ Finish</button>
    </div>

    <div class="room-info" style="text-align:center; margin-bottom:10px; color:#888;">
        Room ID: <strong id="roomIdDisplay">Loading...</strong>
    </div>

    <div class="table-wrapper" id="tableWrapper">
        <table id="scoreTable">
            <thead><tr id="headerRow"><th class="category-col">Category</th></tr></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <div class="history-section">
        <h3>üìú History</h3>
        <div id="historyList"></div>
    </div>

    <div id="debug-console">System Log:<br></div>

    <!-- Modals -->
    <div id="ruleModal" class="modal-backdrop" onclick="if(event.target === this) this.style.display='none'">
        <div class="modal">
            <h3 id="ruleTitle">Rule</h3>
            <div id="ruleText" class="rule-desc"></div>
            <button onclick="document.getElementById('ruleModal').style.display='none'">Got it</button>
        </div>
    </div>

    <div id="pinModal" class="modal-backdrop">
        <div class="modal">
            <h3>üîí Room Locked</h3>
            <p>Please enter the PIN to edit scores.</p>
            <input type="password" id="pinInput" placeholder="Enter PIN" style="width: 100%; margin-bottom: 10px;">
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button onclick="verifyPin()">Unlock</button>
                <button class="secondary" onclick="document.getElementById('pinModal').style.display='none'">View Only</button>
            </div>
        </div>
    </div>

    <div id="setPinModal" class="modal-backdrop">
        <div class="modal">
            <h3>üîê Set Room PIN</h3>
            <p>Protect this scoreboard?</p>
            <input type="text" id="newPinInput" placeholder="Create 4-digit PIN" maxlength="4" style="width: 100%; margin-bottom: 10px;">
            <button onclick="setRoomPin()">Set Lock</button><br><br>
            <button class="secondary" style="font-size: 0.8em;" onclick="removeRoomPin()">Remove Lock</button>
            <button class="secondary" style="font-size: 0.8em;" onclick="document.getElementById('setPinModal').style.display='none'">Cancel</button>
        </div>
    </div>

    <script>
        // --- LOGGING ---
        function log(msg, type="info") {
            const c = document.getElementById('debug-console');
            if(type==='error') c.style.display = 'block';
            const line = document.createElement('div');
            line.textContent = `> ${msg}`;
            if(type==='error') line.className='log-err';
            else if(type==='success') line.className='log-ok';
            c.appendChild(line);
            console.log(msg);
        }

        // --- 1. STARTUP (No external dependencies) ---
        let gameId = window.location.hash.replace('#', '');
        if (!gameId || gameId.length < 2) {
            gameId = Math.random().toString(36).substr(2, 6);
            window.location.hash = gameId;
            log("Generated ID: " + gameId);
        } else {
            log("Found ID: " + gameId);
        }
        document.getElementById('roomIdDisplay').innerText = gameId;

        // --- 2. FIREBASE SETUP (Compat Mode) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDu86vB2-zePebM5oL_onW5E5Aiszgzh84",
            authDomain: "yatzy-eb87c.firebaseapp.com",
            databaseURL: "https://yatzy-eb87c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "yatzy-eb87c",
            storageBucket: "yatzy-eb87c.firebasestorage.app",
            messagingSenderId: "720938944178",
            appId: "1:720938944178:web:de183e0ca6a116b915ebab",
            measurementId: "G-6FCGWX4R4L"
        };

        let db;
        let playerData = {};
        let roomPin = null;
        let isAuthorized = false;
        let soundEnabled = true;

        // Wait for scripts to load, then init
        window.onload = function() {
            if (typeof firebase !== 'undefined') {
                log("Firebase Scripts Loaded", "success");
                try {
                    firebase.initializeApp(firebaseConfig);
                    db = firebase.database();
                    log("Firebase Initialized. Connecting...");
                    setupListeners();
                    updateLanguage();
                } catch (e) {
                    log("INIT ERROR: " + e.message, "error");
                }
            } else {
                log("CRITICAL: Firebase scripts failed to load.", "error");
                alert("Error: Check internet connection.");
            }
        };

        function setupListeners() {
            const roomRef = db.ref(`games/${gameId}`);
            roomRef.on('value', (snapshot) => {
                log("Data received", "success");
                const data = snapshot.val() || {};

                // Animation Logic for Yatzy
                const newPlayers = data.current?.players || {};
                if (playerData) {
                    Object.keys(newPlayers).forEach(pid => {
                        const oldScore = playerData[pid]?.scores?.yatzy;
                        const newScore = newPlayers[pid]?.scores?.yatzy;
                        if (newScore === 50 && oldScore !== 50) {
                            Sound.yatzy();
                            startConfetti();
                        }
                    });
                }

                playerData = newPlayers;
                roomPin = data.settings?.pin || null;
                
                document.getElementById('lockBtn').innerText = roomPin ? 'üîí' : 'üîì';
                document.getElementById('statusDot').classList.add('online');
                renderTable();
            }, (err) => {
                log("DB Error: " + err.message, "error");
            });

            // History & Winner Animation
            const historyRef = db.ref(`games/${gameId}/history`);
            historyRef.on('child_added', (snapshot) => {
                 const val = snapshot.val();
                 const finishedTime = new Date(val.date).getTime();
                 // If game finished within last 30 seconds, animate
                 if (Date.now() - finishedTime < 30000) {
                     // Check if we already showed this one (optional optimization, but good for UX)
                     // For now, just show it.
                     const winningScore = val.results.find(r => r.name === val.winner)?.score || 0;
                     showWinnerOverlay(val.winner, winningScore);
                 }
            });
            historyRef.on('value', (snap) => renderHistory(snap.val()));
        }

        // --- TRANSLATIONS ---
        const TRANSLATIONS = {
            en: {
                yatzy: "Yatzy",
                enter_name: "Enter Player Name",
                add_player: "+ Add Player",
                share: "üîó Share",
                finish: "üèÜ Finish",
                room_id: "Room ID:",
                loading: "Loading...",
                category: "Category",
                history: "üìú History",
                system_log: "System Log:",
                rule_title: "Rule",
                got_it: "Got it",
                room_locked: "üîí Room Locked",
                enter_pin_msg: "Please enter the PIN to edit scores.",
                enter_pin_ph: "Enter PIN",
                unlock: "Unlock",
                view_only: "View Only",
                set_pin_title: "üîê Set Room PIN",
                protect_msg: "Protect this scoreboard?",
                create_pin_ph: "Create 4-digit PIN",
                set_lock: "Set Lock",
                remove_lock: "Remove Lock",
                cancel: "Cancel",
                link_copied: "Link copied!",
                no_players: "No players",
                finish_confirm: "Finish game?\nWinner: {winner} ({score})",
                winner_alert: "üèÜ WINNER: {winner} üèÜ",
                positive_only: "Positive only",
                max_is: "Max is {max}",
                val_50_or_0: "50 or 0",
                min_4_digits: "Min 4 digits",
                unlocked: "Unlocked!",
                incorrect_pin: "Incorrect PIN",
                ones: "Ones", ones_rule: "Sum of ones. Max 5.",
                twos: "Twos", twos_rule: "Sum of twos. Max 10.",
                threes: "Threes", threes_rule: "Sum of threes. Max 15.",
                fours: "Fours", fours_rule: "Sum of fours. Max 20.",
                fives: "Fives", fives_rule: "Sum of fives. Max 25.",
                sixes: "Sixes", sixes_rule: "Sum of sixes. Max 30.",
                sum: "Sum",
                bonus: "Bonus", bonus_rule: "If Sum ‚â• 63, score 50.",
                pair: "One Pair", pair_rule: "Sum of two same dice.",
                twoPair: "Two Pairs", twoPair_rule: "Sum of two different pairs.",
                threeKind: "3 of a Kind", threeKind_rule: "Sum of three same dice.",
                fourKind: "4 of a Kind", fourKind_rule: "Sum of four same dice.",
                smallStr: "Small Str.", smallStr_rule: "Seq of 1-2-3-4-5. Score 15.",
                largeStr: "Large Str.", largeStr_rule: "Seq of 2-3-4-5-6. Score 20.",
                fullHouse: "Full House", fullHouse_rule: "3 of one + 2 of another.",
                chance: "Chance", chance_rule: "Sum of all 5 dice.",
                yatzy_cat: "Yatzy", yatzy_rule: "All 5 same. 50 or 0.",
                total: "TOTAL"
            },
            fi: {
                yatzy: "Yatzy",
                enter_name: "Anna pelaajan nimi",
                add_player: "+ Lis√§√§ pelaaja",
                share: "üîó Jaa",
                finish: "üèÜ Lopeta",
                room_id: "Huoneen tunnus:",
                loading: "Ladataan...",
                category: "Kategoria",
                history: "üìú Historia",
                system_log: "J√§rjestelm√§loki:",
                rule_title: "S√§√§nt√∂",
                got_it: "Selv√§",
                room_locked: "üîí Huone lukittu",
                enter_pin_msg: "Anna PIN muokataksesi pisteit√§.",
                enter_pin_ph: "Anna PIN",
                unlock: "Avaa",
                view_only: "Vain katselu",
                set_pin_title: "üîê Aseta huoneen PIN",
                protect_msg: "Suojaa tulostaulu?",
                create_pin_ph: "Luo 4-numeroinen PIN",
                set_lock: "Lukitse",
                remove_lock: "Poista lukitus",
                cancel: "Peruuta",
                link_copied: "Linkki kopioitu!",
                no_players: "Ei pelaajia",
                finish_confirm: "Lopeta peli?\nVoittaja: {winner} ({score})",
                winner_alert: "üèÜ VOITTAJA: {winner} üèÜ",
                positive_only: "Vain positiiviset",
                max_is: "Maksimi on {max}",
                val_50_or_0: "50 tai 0",
                min_4_digits: "V√§hint√§√§n 4 numeroa",
                unlocked: "Avattu!",
                incorrect_pin: "V√§√§r√§ PIN",
                ones: "Ykk√∂set", ones_rule: "Ykk√∂sten summa. Max 5.",
                twos: "Kakkoset", twos_rule: "Kakkosten summa. Max 10.",
                threes: "Kolmoset", threes_rule: "Kolmosten summa. Max 15.",
                fours: "Neloset", fours_rule: "Nelosten summa. Max 20.",
                fives: "Viitoset", fives_rule: "Viitosten summa. Max 25.",
                sixes: "Kuutoset", sixes_rule: "Kuutosten summa. Max 30.",
                sum: "Summa",
                bonus: "Bonus", bonus_rule: "Jos summa ‚â• 63, 50 pistett√§.",
                pair: "Yksi pari", pair_rule: "Kahden saman silm√§luvun summa.",
                twoPair: "Kaksi paria", twoPair_rule: "Kahden eri parin summa.",
                threeKind: "Kolmoisluku", threeKind_rule: "Kolmen saman silm√§luvun summa.",
                fourKind: "Neloisluku", fourKind_rule: "Nelj√§n saman silm√§luvun summa.",
                smallStr: "Pieni suora", smallStr_rule: "4 per√§kk√§ist√§. 15.",
                largeStr: "Iso suora", largeStr_rule: "5 per√§kk√§ist√§. 20.",
                fullHouse: "T√§ysk√§si", fullHouse_rule: "3 samaa + 2 samaa.",
                chance: "Sattuma", chance_rule: "Kaikkien 5 nopan summa.",
                yatzy_cat: "Yatzy", yatzy_rule: "Kaikki 5 samaa. 50 tai 0.",
                total: "YHTEENS√Ñ"
            }
        };

        let currentLang = 'en';

        function t(key, params={}) {
            let str = TRANSLATIONS[currentLang][key] || key;
            for (const [k, v] of Object.entries(params)) {
                str = str.replace(`{${k}}`, v);
            }
            return str;
        }

        function updateLanguage() {
            document.getElementById('appTitle').textContent = t('yatzy');
            document.getElementById('playerName').placeholder = t('enter_name');
            document.querySelector('button[onclick="addPlayer()"]').innerText = t('add_player');
            document.querySelector('button[onclick="copyLink()"]').innerText = t('share');
            document.querySelector('button[onclick="archiveAndReset()"]').innerText = t('finish');

            const roomInfo = document.querySelector('.room-info');
            roomInfo.childNodes[0].textContent = t('room_id') + " ";

            const tableHeader = document.querySelector('#scoreTable th.category-col');
            if (tableHeader) tableHeader.innerText = t('category');

            document.querySelector('.history-section h3').innerText = t('history');
            document.getElementById('debug-console').childNodes[0].textContent = t('system_log') + "\n";

            document.getElementById('ruleTitle').innerText = t('rule_title');
            document.querySelector('#ruleModal button').innerText = t('got_it');

            document.querySelector('#pinModal h3').innerText = t('room_locked');
            document.querySelector('#pinModal p').innerText = t('enter_pin_msg');
            document.getElementById('pinInput').placeholder = t('enter_pin_ph');
            document.querySelector('#pinModal button[onclick="verifyPin()"]').innerText = t('unlock');
            document.querySelector('#pinModal button.secondary').innerText = t('view_only');

            document.querySelector('#setPinModal h3').innerText = t('set_pin_title');
            document.querySelector('#setPinModal p').innerText = t('protect_msg');
            document.getElementById('newPinInput').placeholder = t('create_pin_ph');
            document.querySelector('#setPinModal button[onclick="setRoomPin()"]').innerText = t('set_lock');
            document.querySelector('#setPinModal button[onclick="removeRoomPin()"]').innerText = t('remove_lock');
            document.querySelectorAll('#setPinModal button.secondary')[1].innerText = t('cancel');

            document.getElementById('langBtn').innerText = currentLang === 'en' ? 'üá´üáÆ' : 'üá¨üáß';
            renderTable();
        }

        window.toggleLanguage = function() {
            currentLang = currentLang === 'en' ? 'fi' : 'en';
            updateLanguage();
        };

        // --- LOGIC ---
        const RULES={ones:5,twos:10,threes:15,fours:20,fives:25,sixes:30,pair:12,twoPair:22,threeKind:30,fourKind:30,smallStr:30,largeStr:40,fullHouse:28,chance:30,yatzy:50};
        const CATEGORIES=[
            {id:'ones'}, {id:'twos'}, {id:'threes'}, {id:'fours'}, {id:'fives'}, {id:'sixes'},
            {id:'sum', type:'calc'},
            {id:'bonus', type:'calc'},
            {id:'pair'}, {id:'twoPair'}, {id:'threeKind'}, {id:'fourKind'},
            {id:'smallStr'}, {id:'largeStr'}, {id:'fullHouse'}, {id:'chance'}, {id:'yatzy'},
            {id:'total', type:'calc'}
        ];

        // Global functions for buttons
        window.addPlayer = function() {
            if(!checkAuth()) return;
            const name = document.getElementById('playerName').value.trim();
            if(!name) return;
            Sound.tap();
            db.ref(`games/${gameId}/current/players/p_${Date.now()}`).update({ name: name, scores: {} });
            document.getElementById('playerName').value = '';
        };

        window.updateScore = function(pid, cat, val) {
            if(!checkAuth()) { renderTable(); return; }
            const num = Number(val);
            let err = "";
            if(val!=='') {
                if(isNaN(num)||num<0) err=t('positive_only');
                else if(RULES[cat] && num>RULES[cat]) err=t('max_is', {max: RULES[cat]});
                else if(cat==='yatzy' && num!==0 && num!==50) err=t('val_50_or_0');
            }
            if(err) {
                Sound.error(); alert(err); 
                const el = document.querySelector(`input[data-pid="${pid}"][data-cat="${cat}"]`);
                if(el) { el.classList.add('invalid-shake'); setTimeout(()=>el.classList.remove('invalid-shake'),500); }
                renderTable(); return;
            }
            // Removed local animation triggers to rely on DB listeners (all users see it)
            if(val!=='') {
                if (!(cat === 'yatzy' && num === 50)) {
                    Sound.score();
                }
            }
            
            db.ref(`games/${gameId}/current/players/${pid}/scores/${cat}`).set(val===''?null:num);
        };

        window.archiveAndReset = function() {
            if(!checkAuth()) return;
            const pList = playerData ? Object.values(playerData) : [];
            if(!pList.length) return alert(t('no_players'));
            
            let winner="None", max=-1, results=[];
            pList.forEach(p => {
                let s = calculateTotal(p.scores||{});
                results.push({name:p.name, score:s});
                if(s>max) { max=s; winner=p.name; }
            });

            if(!confirm(t('finish_confirm', {winner: winner, score: max}))) return;
            // Removed local animation/alert. DB listener will trigger it.
            
            db.ref(`games/${gameId}/history`).push({ date: new Date().toISOString(), winner: winner, results: results });
            
            const updates={};
            Object.keys(playerData).forEach(pid => updates[`players/${pid}/scores`] = null);
            db.ref(`games/${gameId}/current`).update(updates);
        };

        // --- RENDER & HELPERS ---
        function renderTable() {
            const hRow = document.getElementById('headerRow');
            const tbody = document.getElementById('tableBody');
            while(hRow.children.length > 1) hRow.removeChild(hRow.lastChild);
            
            const pids = Object.keys(playerData).sort();
            pids.forEach(pid => {
                const th = document.createElement('th');
                th.innerText = playerData[pid].name;
                hRow.appendChild(th);
            });

            tbody.innerHTML = '';
            CATEGORIES.forEach(cat => {
                const tr = document.createElement('tr');
                if(cat.id.includes('sum')||cat.id.includes('bonus')) tr.className='subtotal-row';
                if(cat.id==='total') tr.className='total-row';

                const tdLabel = document.createElement('td');
                tdLabel.className='category-col';
                // Use translation
                const catKey = cat.id === 'yatzy' ? 'yatzy_cat' : cat.id; // handle key collision with app title
                const label = t(catKey);
                const rule = t(catKey + '_rule');

                tdLabel.innerHTML=`<span>${label}</span>`;
                if(rule && rule !== catKey + '_rule') { // if translation exists
                    const i = document.createElement('span'); i.className='help-icon'; i.innerText='?';
                    i.onclick=()=>window.showRule(label, rule); tdLabel.appendChild(i);
                }
                tr.appendChild(tdLabel);

                pids.forEach(pid => {
                    const td = document.createElement('td');
                    const scores = playerData[pid].scores || {};
                    if(cat.type==='calc') {
                        td.innerText = calculateField(cat.id, scores);
                    } else {
                        const val = (scores[cat.id]!==undefined) ? scores[cat.id] : '';
                        const inp = document.createElement('input');
                        inp.className='score-input'; inp.type='tel'; inp.value=val; inp.placeholder='-';
                        inp.setAttribute('data-pid', pid); inp.setAttribute('data-cat', cat.id);
                        inp.onchange=(e)=>window.updateScore(pid, cat.id, e.target.value);
                        td.appendChild(inp);
                    }
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }

        function calculateField(type, s) {
            const upper = ['ones','twos','threes','fours','fives','sixes'];
            let sum=0; upper.forEach(k => sum+=Number(s[k]||0));
            if(type==='sum') return sum;
            if(type==='bonus') return sum>=63?50:0;
            if(type==='total') {
                let t=sum+(sum>=63?50:0);
                ['pair','twoPair','threeKind','fourKind','smallStr','largeStr','fullHouse','chance','yatzy']
                    .forEach(k=>t+=Number(s[k]||0));
                return t;
            }
            return 0;
        }
        function calculateTotal(s){return calculateField('total',s);}

        function renderHistory(h){
            const l=document.getElementById('historyList'); l.innerHTML=''; if(!h)return;
            Object.values(h).reverse().forEach(g=>{
                const d=document.createElement('div'); d.className='history-card';
                d.innerHTML=`<span>üèÜ <b>${g.winner}</b></span> <span>${g.results.find(r=>r.name===g.winner)?.score} pts</span> <span style="font-size:0.8em;color:#888">${new Date(g.date).toLocaleDateString()}</span>`;
                l.appendChild(d);
            });
        }

        // --- MISSING FUNCTIONS RECONSTRUCTED ---

        window.showRule = function(title, text) {
             document.getElementById('ruleTitle').innerText = title;
             document.getElementById('ruleText').innerText = text;
             document.getElementById('ruleModal').style.display = 'flex';
        };

        window.toggleSound = function() {
            soundEnabled = !soundEnabled;
            document.getElementById('soundBtn').innerText = soundEnabled ? 'üîä' : 'üîá';
        };

        window.toggleTheme = function() {
            const body = document.body;
            if (body.getAttribute('data-theme') === 'light') {
                body.removeAttribute('data-theme');
                document.getElementById('themeBtn').innerText = '‚òÄÔ∏è';
            } else {
                body.setAttribute('data-theme', 'light');
                document.getElementById('themeBtn').innerText = 'üåô';
            }
        };

        window.copyLink = function() {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => alert(t('link_copied')));
        };

        window.toggleLockModal = function() {
            if (roomPin) {
                 if (isAuthorized) {
                     document.getElementById('newPinInput').value = '';
                     document.getElementById('setPinModal').style.display = 'flex';
                 } else {
                     document.getElementById('pinInput').value = '';
                     document.getElementById('pinModal').style.display = 'flex';
                 }
            } else {
                document.getElementById('newPinInput').value = '';
                document.getElementById('setPinModal').style.display = 'flex';
            }
        };

        window.verifyPin = function() {
            const input = document.getElementById('pinInput').value;
            if (input === roomPin) {
                isAuthorized = true;
                document.getElementById('pinModal').style.display = 'none';
                alert(t('unlocked'));
            } else {
                alert(t('incorrect_pin'));
                Sound.error();
            }
        };

        window.setRoomPin = function() {
            const pin = document.getElementById('newPinInput').value;
            if (pin.length < 4) { alert(t('min_4_digits')); return; }
            db.ref(`games/${gameId}/settings/pin`).set(pin);
            document.getElementById('setPinModal').style.display = 'none';
            isAuthorized = true;
        };

        window.removeRoomPin = function() {
             if (!roomPin) return;
             db.ref(`games/${gameId}/settings/pin`).remove();
             document.getElementById('setPinModal').style.display = 'none';
             isAuthorized = false;
        };

        function checkAuth() {
            if (!roomPin) return true;
            if (isAuthorized) return true;
            document.getElementById('pinInput').value = '';
            document.getElementById('pinModal').style.display = 'flex';
            return false;
        }

        const Sound = {
            tap: () => playTone(800, 'square'),
            error: () => playTone(150, 'sawtooth', 0.3),
            yatzy: () => { playTone(600,'sine',0.1); setTimeout(()=>playTone(800,'sine',0.1), 100); },
            score: () => playTone(1000, 'sine'),
            fanfare: () => { playTone(500); setTimeout(()=>playTone(700), 200); }, // Legacy fallback
            victory: () => {
                // Majestic Victory Fanfare (Final Fantasy style intro approx)
                const now = audioCtx.currentTime;
                // C major fanfare: C4, C4, C4, C4, G#3, Bb3, C4, Bb3, C4
                // Let's do a simple triumphant arpeggio sequence
                const tune = [
                    {f:523.25, d:0.15, t:0},    // C5
                    {f:523.25, d:0.15, t:0.15}, // C5
                    {f:523.25, d:0.15, t:0.30}, // C5
                    {f:659.25, d:0.40, t:0.45}, // E5
                    {f:783.99, d:0.40, t:0.85}, // G5
                    {f:1046.50, d:1.5, t:1.25}  // C6
                ];
                tune.forEach(n => {
                    setTimeout(() => playTone(n.f, 'triangle', n.d), n.t * 1000);
                    setTimeout(() => playTone(n.f * 0.5, 'sawtooth', n.d), n.t * 1000); // Add bass/harmony octave down
                });
            }
        };

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(freq, type='sine', dur=0.1) {
            if(!soundEnabled) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);

            // Envelope
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);

            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + dur);
        }

        // --- NEW CONFETTI & WINNER OVERLAY ---
        let confettiInterval = null;

        function showWinnerOverlay(winnerName, score) {
            document.getElementById('winnerNameDisplay').innerText = winnerName;
            document.getElementById('winnerScoreDisplay').innerText = t('total') + ": " + score;
            document.getElementById('winnerOverlay').style.display = 'flex';
            Sound.victory();
            startConfetti(true); // Continuous confetti
        }

        window.closeWinnerOverlay = function() {
            document.getElementById('winnerOverlay').style.display = 'none';
            stopConfetti();
        };

        function startConfetti(continuous = false) {
            const canvas = document.getElementById('confetti');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            let particles = [];
            const colors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4caf50', '#8bc34a', '#cddc39', '#ffeb3b', '#ffc107', '#ff9800', '#ff5722'];

            function createParticle() {
                return {
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height - canvas.height,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    size: Math.random() * 10 + 5,
                    velY: Math.random() * 3 + 2,
                    velX: Math.random() * 4 - 2,
                    rotation: Math.random() * 360,
                    rotationSpeed: Math.random() * 10 - 5
                };
            }

            // Initial burst
            for(let i=0; i<150; i++) particles.push(createParticle());

            let frame = 0;
            function loop() {
                if (!continuous && frame++ > 300) {
                    ctx.clearRect(0,0,canvas.width,canvas.height);
                    return;
                }

                // If stopped externally
                if (continuous && document.getElementById('winnerOverlay').style.display === 'none') {
                    ctx.clearRect(0,0,canvas.width,canvas.height);
                    return;
                }

                ctx.clearRect(0,0,canvas.width,canvas.height);

                // Add new particles if continuous
                if (continuous && particles.length < 150) {
                     particles.push(createParticle());
                }

                particles.forEach((p, index) => {
                    p.y += p.velY;
                    p.x += p.velX;
                    p.rotation += p.rotationSpeed;

                    if (p.y > canvas.height) {
                        if (continuous) {
                            p.y = -20;
                            p.x = Math.random() * canvas.width;
                        } else {
                            particles.splice(index, 1);
                        }
                    }

                    ctx.save();
                    ctx.translate(p.x, p.y);
                    ctx.rotate(p.rotation * Math.PI / 180);
                    ctx.fillStyle = p.color;
                    ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
                    ctx.restore();
                });

                if (particles.length > 0) {
                    requestAnimationFrame(loop);
                }
            }
            loop();
        }

        function stopConfetti() {
             // Logic handled in loop check
             const canvas = document.getElementById('confetti');
             const ctx = canvas.getContext('2d');
             ctx.clearRect(0,0,canvas.width,canvas.height);
        }

    </script>
</body>
</html>

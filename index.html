<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yatzy Live (Cloud)</title>
    <style>
        :root { --bg: #1a1a1a; --text: #e0e0e0; --accent: #2196F3; --border: #333; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            padding: 10px; 
            display:flex; 
            flex-direction:column; 
            align-items:center; 
            margin: 0;
        }
        .controls { 
            background: #252525; 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 20px; 
            display:flex; 
            gap:10px; 
            flex-wrap:wrap; 
            justify-content:center; 
            width:100%; 
            max-width:600px; 
            border: 1px solid var(--border);
        }
        button { 
            background: var(--accent); 
            color: white; 
            border: none; 
            padding: 12px 20px; 
            border-radius: 6px; 
            font-weight: bold; 
            font-size: 1rem; 
            cursor: pointer;
        }
        button:active { transform: scale(0.98); }
        input[type="text"] { 
            padding: 12px; 
            border-radius: 6px; 
            border: 1px solid #555; 
            background: #2a2a2a; 
            color: white; 
            flex-grow: 1; 
            font-size: 1rem; 
        }
        .score-container { 
            overflow-x: auto; 
            width: 100%; 
            max-width: 800px;
            border-radius: 8px; 
            background: #252525; 
            border: 1px solid var(--border); 
        }
        table { width: 100%; border-collapse: collapse; min-width: 300px; }
        th, td { border: 1px solid #444; padding: 10px 5px; text-align: center; white-space: nowrap; }
        .category-label { 
            text-align: left; 
            font-weight: bold; 
            padding-left: 10px; 
            background: #2a2a2a; 
            position: sticky; 
            left: 0; 
            width: 110px; 
            border-right: 2px solid #555; 
            z-index: 10;
        }
        .subtotal-row { background: #2c3e50; font-weight: bold; }
        .total-row { background: #1b5e20; font-weight: bold; }
        input.score-input { 
            width: 100%; 
            min-width: 40px; 
            background: transparent; 
            border: none; 
            color: white; 
            text-align: center; 
            font-size: 1.1em; 
        }
        .status-bar { margin-top: 15px; font-size: 0.9em; color: #888; text-align: center; }
        .online { color: #4caf50; font-weight: bold; }
    </style>
</head>
<body>

    <h1>üé≤ Yatzy Cloud</h1>

    <div class="controls">
        <input type="text" id="playerName" placeholder="Enter Name">
        <button onclick="addPlayer()">Add Player</button>
        <button style="background:#555" onclick="copyLink()">Share Link</button>
    </div>

    <div class="score-container">
        <table id="scoreTable">
            <thead><tr id="headerRow"><th class="category-label">Category</th></tr></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <div class="status-bar">
        Room: <strong id="roomIdDisplay">...</strong><br>
        Status: <span id="statusText">Connecting...</span>
    </div>

<script type="module">
    // Import from Firebase SDK v12.6.0
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, update } 
           from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

    // --- YOUR CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyDu86vB2-zePebM5oL_onW5E5Aiszgzh84",
        authDomain: "yatzy-eb87c.firebaseapp.com",
        databaseURL: "https://yatzy-eb87c-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "yatzy-eb87c",
        storageBucket: "yatzy-eb87c.firebasestorage.app",
        messagingSenderId: "720938944178",
        appId: "1:720938944178:web:de183e0ca6a116b915ebab",
        measurementId: "G-6FCGWX4R4L"
    };
    // --------------------------

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Get Room ID
    let gameId = window.location.hash.replace('#', '');
    if (!gameId) { 
        gameId = Math.random().toString(36).substr(2, 6); 
        window.location.hash = gameId; 
    }
    document.getElementById('roomIdDisplay').innerText = gameId;

    let playerData = {};
    const categories = [
        { id: 'ones', label: 'Ones' }, { id: 'twos', label: 'Twos' }, { id: 'threes', label: 'Threes' },
        { id: 'fours', label: 'Fours' }, { id: 'fives', label: 'Fives' }, { id: 'sixes', label: 'Sixes' },
        { id: 'sum', label: 'Sum', type: 'calc' }, { id: 'bonus', label: 'Bonus', type: 'calc' },
        { id: 'pair', label: 'One Pair' }, { id: 'twoPair', label: 'Two Pairs' }, { id: 'threeKind', label: '3 of a Kind' },
        { id: 'fourKind', label: '4 of a Kind' }, { id: 'smallStr', label: 'Small Str.' }, { id: 'largeStr', label: 'Large Str.' },
        { id: 'fullHouse', label: 'Full House' }, { id: 'chance', label: 'Chance' }, { id: 'yatzy', label: 'Yatzy' },
        { id: 'total', label: 'TOTAL', type: 'calc' }
    ];

    // --- LISTENERS ---
    const roomRef = ref(db, 'games/' + gameId);
    
    // Listen for ANY change in this room
    onValue(roomRef, (snapshot) => {
        const data = snapshot.val();
        document.getElementById('statusText').innerHTML = "<span class='online'>‚óè Online & Synced</span>";
        if (data) {
            playerData = data;
            renderTable();
        } else {
            // Room is empty, just render empty table
            playerData = {};
            renderTable();
        }
    });

    // --- ACTIONS ---
    window.addPlayer = function() {
        const name = document.getElementById('playerName').value;
        if(!name) return alert("Enter a name first!");
        
        // Create a unique ID for this player
        const pid = 'p_' + Date.now();
        
        // Save initial state to Firebase
        update(ref(db, `games/${gameId}/${pid}`), {
            name: name,
            ones:0, twos:0, threes:0, fours:0, fives:0, sixes:0
        });
        document.getElementById('playerName').value = '';
    }

    window.updateScore = function(pid, cat, val) {
        if(val === '') val = 0;
        // Directly update the database
        set(ref(db, `games/${gameId}/${pid}/${cat}`), Number(val));
    }

    window.copyLink = function() { 
        navigator.clipboard.writeText(window.location.href); 
        alert("Link copied! Anyone with this link can join."); 
    }

    // --- RENDERING ---
    function renderTable() {
        const hRow = document.getElementById('headerRow');
        const tbody = document.getElementById('tableBody');
        
        // Reset Header
        hRow.innerHTML = '<th class="category-label">Category</th>';
        tbody.innerHTML = '';

        const pids = Object.keys(playerData).sort();
        
        // Build Header Columns
        pids.forEach(pid => {
            const th = document.createElement('th');
            th.innerText = playerData[pid].name;
            hRow.appendChild(th);
        });

        // Build Rows
        categories.forEach(cat => {
            const tr = document.createElement('tr');
            if(cat.id === 'sum' || cat.id === 'bonus') tr.className = 'subtotal-row';
            if(cat.id === 'total') tr.className = 'total-row';
            
            // Label Column
            tr.innerHTML = `<td class="category-label">${cat.label}</td>`;
            
            // Player Columns
            pids.forEach(pid => {
                const td = document.createElement('td');
                const p = playerData[pid];
                
                if(cat.type === 'calc') {
                    td.innerText = calculate(p, cat.id);
                } else {
                    const val = (p[cat.id] !== undefined && p[cat.id] !== 0) ? p[cat.id] : '';
                    // Input field updates Firebase on change
                    td.innerHTML = `<input class="score-input" type="tel" value="${val}" onchange="updateScore('${pid}','${cat.id}',this.value)">`;
                }
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
    }

    function calculate(p, type) {
        const upper = ['ones','twos','threes','fours','fives','sixes'];
        let sum = 0;
        upper.forEach(k => sum += Number(p[k]||0));
        
        if(type==='sum') return sum;
        if(type==='bonus') return sum >= 63 ? 50 : 0;
        if(type==='total') {
            let t = sum + (sum>=63?50:0);
            ['pair','twoPair','threeKind','fourKind','smallStr','largeStr','fullHouse','chance','yatzy']
                .forEach(k => t += Number(p[k]||0));
            return t;
        }
        return 0;
    }
</script>
</body>
</html>


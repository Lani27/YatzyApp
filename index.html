<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yatzy Torrent</title>
    <style>
        :root { --bg: #1a1a1a; --text: #e0e0e0; --accent: #4caf50; --border: #333; }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); padding: 10px; display:flex; flex-direction:column; align-items:center; }
        .controls { background: #252525; padding: 15px; border-radius: 8px; margin-bottom: 20px; display:flex; gap:10px; flex-wrap:wrap; justify-content:center; width:100%; max-width:600px; }
        button { background: var(--accent); color: white; border: none; padding: 10px 16px; border-radius: 4px; font-weight: bold; }
        input[type="text"] { padding: 10px; border-radius: 4px; border: 1px solid #555; background: #2a2a2a; color: white; flex-grow: 1; }
        .score-container { overflow-x: auto; width: 100%; border-radius: 8px; background: #252525; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; min-width: 300px; }
        th, td { border: 1px solid #444; padding: 8px; text-align: center; white-space: nowrap; }
        .category-label { text-align: left; font-weight: bold; padding-left: 10px; background: #2a2a2a; position: sticky; left: 0; width: 110px; border-right: 2px solid #555; }
        .subtotal-row { background: #2c3e50; font-weight: bold; }
        .total-row { background: #1b5e20; font-weight: bold; }
        input.score-input { width: 100%; min-width: 40px; background: transparent; border: none; color: white; text-align: center; font-size: 1.1em; }
        .status-bar { margin-top: 15px; font-size: 0.9em; color: #888; text-align: center; }
        .live { color: #4caf50; font-weight: bold; }
    </style>
</head>
<body>

    <h1>üé≤ Yatzy (Torrent Mode)</h1>

    <div class="controls">
        <input type="text" id="playerName" placeholder="Enter Name">
        <button onclick="addPlayer()">Add Player</button>
        <button style="background:#555" onclick="copyLink()">Share Link</button>
    </div>

    <div class="score-container">
        <table id="scoreTable">
            <thead><tr id="headerRow"><th class="category-label">Category</th></tr></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <div class="status-bar">
        Room: <strong id="roomIdDisplay">...</strong><br>
        <span id="statusText">Connecting via Torrent...</span>
    </div>

<script type="module">
    // IMPORT TRYSTERO (Torrent Library)
    import { joinRoom } from 'https://cdn.skypack.dev/trystero/torrent';

    // 1. SETUP GAME
    let gameId = window.location.hash.replace('#', '');
    if (!gameId) { gameId = Math.random().toString(36).substr(2, 6); window.location.hash = gameId; }
    document.getElementById('roomIdDisplay').innerText = gameId;

    // Connect to room (AppId + RoomId)
    const config = { appId: 'yatzy-live-v1' };
    const room = joinRoom(config, gameId);
    
    // Actions
    const [sendData, getScore] = room.makeAction('scoreUpdate');
    const [sendPlayer, getPlayer] = room.makeAction('newPlayer');

    let playerData = {};
    const categories = [
        { id: 'ones', label: 'Ones' }, { id: 'twos', label: 'Twos' }, { id: 'threes', label: 'Threes' },
        { id: 'fours', label: 'Fours' }, { id: 'fives', label: 'Fives' }, { id: 'sixes', label: 'Sixes' },
        { id: 'sum', label: 'Sum', type: 'calc' }, { id: 'bonus', label: 'Bonus', type: 'calc' },
        { id: 'pair', label: 'One Pair' }, { id: 'twoPair', label: 'Two Pairs' }, { id: 'threeKind', label: '3 of a Kind' },
        { id: 'fourKind', label: '4 of a Kind' }, { id: 'smallStr', label: 'Small Str.' }, { id: 'largeStr', label: 'Large Str.' },
        { id: 'fullHouse', label: 'Full House' }, { id: 'chance', label: 'Chance' }, { id: 'yatzy', label: 'Yatzy' },
        { id: 'total', label: 'TOTAL', type: 'calc' }
    ];

    // 2. NETWORK LISTENERS
    room.onPeerJoin(peerId => {
        document.getElementById('statusText').innerHTML = "<span class='live'>‚óè Peer Joined! syncing...</span>";
        // Send them my full state so they are up to date
        Object.keys(playerData).forEach(pid => sendPlayer(playerData[pid]));
    });

    room.onPeerLeave(() => {
        document.getElementById('statusText').innerText = "Peer left.";
    });

    getPlayer((data) => {
        playerData[data.id] = data;
        renderTable();
    });

    getScore((data) => {
        if(playerData[data.pid]) {
            playerData[data.pid][data.cat] = Number(data.val);
            renderTable();
        }
    });

    // 3. UI FUNCTIONS
    window.addPlayer = function() {
        const name = document.getElementById('playerName').value;
        if(!name) return alert("Name?");
        const pid = 'p_' + Date.now();
        const p = { id: pid, name: name };
        playerData[pid] = p;
        sendPlayer(p); // Broadcast
        renderTable();
        document.getElementById('playerName').value = '';
    }

    window.updateScore = function(pid, cat, val) {
        if(val === '') val = 0;
        playerData[pid][cat] = Number(val);
        // Broadcast
        sendData({ pid: pid, cat: cat, val: val });
        renderTable(); // Re-render to update sums
    }

    window.copyLink = function() { navigator.clipboard.writeText(window.location.href); alert("Copied!"); }

    // 4. RENDER LOGIC
    function renderTable() {
        const hRow = document.getElementById('headerRow');
        hRow.innerHTML = '<th class="category-label">Category</th>';
        const pids = Object.keys(playerData).sort();
        pids.forEach(pid => {
            const th = document.createElement('th');
            th.innerText = playerData[pid].name;
            hRow.appendChild(th);
        });

        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        categories.forEach(cat => {
            const tr = document.createElement('tr');
            if(cat.id === 'sum' || cat.id === 'bonus') tr.className = 'subtotal-row';
            if(cat.id === 'total') tr.className = 'total-row';
            
            tr.innerHTML = `<td class="category-label">${cat.label}</td>`;
            
            pids.forEach(pid => {
                const td = document.createElement('td');
                const p = playerData[pid];
                if(cat.type === 'calc') {
                    td.innerText = calculate(p, cat.id);
                } else {
                    const val = p[cat.id] || '';
                    td.innerHTML = `<input class="score-input" type="tel" value="${val}" onchange="updateScore('${pid}','${cat.id}',this.value)">`;
                }
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
    }

    function calculate(p, type) {
        const upper = ['ones','twos','threes','fours','fives','sixes'];
        let sum = 0;
        upper.forEach(k => sum += Number(p[k]||0));
        if(type==='sum') return sum;
        if(type==='bonus') return sum >= 63 ? 50 : 0;
        if(type==='total') {
            let t = sum + (sum>=63?50:0);
            ['pair','twoPair','threeKind','fourKind','smallStr','largeStr','fullHouse','chance','yatzy'].forEach(k=>t+=Number(p[k]||0));
            return t;
        }
    }
</script>
</body>
</html>

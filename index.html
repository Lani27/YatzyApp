<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yatzy Ultimate</title>
    
    <!-- 1. LOAD FIREBASE "CLASSIC" SCRIPTS (More reliable than Modules) -->
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>

    <style>
        /* --- CSS STYLES --- */
        :root {
            --bg: #121212; --surface: #1e1e1e; --text: #e0e0e0; --text-dim: #a0a0a0;
            --accent: #4caf50; --accent-hover: #43a047; --border: #333;
            --highlight: #2c3e50; --shadow-color: rgba(0,0,0,0.5); --danger: #f44336;
        }
        [data-theme="light"] {
            --bg: #f5f5f5; --surface: #ffffff; --text: #212121; --text-dim: #666;
            --accent: #2196F3; --accent-hover: #1976D2; --border: #ddd;
            --highlight: #e3f2fd; --shadow-color: rgba(0,0,0,0.1);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg); color: var(--text); margin: 0; padding: 15px;
            display: flex; flex-direction: column; align-items: center; transition: background 0.3s, color 0.3s;
        }
        header { width: 100%; max-width: 800px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h1 { margin: 0; font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }
        
        /* Status Dot */
        .status-dot { width: 10px; height: 10px; background-color: #f44336; border-radius: 50%; display: inline-block; transition: background 0.3s; }
        .status-dot.online { background-color: #4caf50; box-shadow: 0 0 0 0 rgba(76, 175, 80, 1); animation: pulse-green 2s infinite; }
        @keyframes pulse-green { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); } }

        .header-actions { display: flex; gap: 10px; }
        .icon-btn { background: none; border: 1px solid var(--border); color: var(--text); padding: 5px 10px; border-radius: 8px; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; }
        
        .controls-area { background: var(--surface); padding: 15px; border-radius: 12px; margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; width: 100%; max-width: 600px; border: 1px solid var(--border); }
        button { background-color: var(--accent); color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.9rem; transition: transform 0.1s; }
        button:active { transform: scale(0.96); }
        button.secondary { background-color: #555; }
        button.danger { background-color: #d32f2f; }
        input[type="text"], input[type="password"] { padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--text); flex-grow: 1; min-width: 120px; }

        .table-wrapper { width: 100%; max-width: 900px; overflow-x: auto; border-radius: 12px; border: 1px solid var(--border); background: var(--surface); position: relative; }
        table { border-collapse: collapse; min-width: 100%; }
        th, td { padding: 8px; text-align: center; border: 1px solid var(--border); white-space: nowrap; }
        th { background-color: var(--surface); position: sticky; top: 0; z-index: 20; cursor: pointer; user-select: none; }
        th.active-player, td.active-col { background-color: var(--highlight) !important; }
        .category-col { position: sticky; left: 0; background-color: var(--surface); z-index: 30; text-align: left; font-weight: bold; width: 130px; border-right: 2px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .table-wrapper.scrolled .category-col { box-shadow: 2px 0 5px var(--shadow-color); }
        .help-icon { font-size: 0.8em; color: var(--text-dim); cursor: help; border: 1px solid var(--border); border-radius: 50%; width: 18px; height: 18px; display: inline-flex; align-items: center; justify-content: center; margin-left: 5px; }
        .subtotal-row { background-color: rgba(255, 255, 255, 0.05); font-weight: bold; color: var(--text-dim); }
        .total-row { background-color: var(--accent); color: white; font-weight: bold; font-size: 1.1em; }
        
        input.score-input { width: 50px; background: transparent; border: none; color: var(--text); text-align: center; font-size: 1.1em; font-weight: 500; padding: 5px 0; }
        input.score-input:focus { background: rgba(255,255,255,0.1); outline: none; border-radius: 4px; }
        input.invalid-shake { color: #f44336; border-bottom: 2px solid #f44336; animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(3px); }
        .modal { background: var(--surface); padding: 25px; border-radius: 12px; width: 90%; max-width: 400px; border: 1px solid var(--border); box-shadow: 0 10px 25px rgba(0,0,0,0.5); text-align: center; }
        .rule-desc { text-align: left; line-height: 1.5; margin: 15px 0; }
        .history-section { margin-top: 30px; width: 100%; max-width: 600px; }
        .history-card { background: var(--surface); padding: 10px 15px; margin-bottom: 10px; border-radius: 8px; border: 1px solid var(--border); display: flex; justify-content: space-between; font-size: 0.9rem; }
        #confetti { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }
        
        /* DEBUG LOG */
        #debug-console {
            width: 100%; background: #000; color: #00ff00; font-family: monospace; font-size: 10px;
            padding: 10px; margin-top: 20px; border-top: 1px solid #333; max-height: 100px; overflow-y: auto;
            display: none;
        }
        .log-err { color: #ff4444; }
        .log-ok { color: #44ff44; }
    </style>
</head>
<body>

    <canvas id="confetti"></canvas>

    <header>
        <h1><span id="statusDot" class="status-dot"></span> Yatzy</h1>
        <div class="header-actions">
            <button class="icon-btn" id="soundBtn" onclick="toggleSound()">üîä</button>
            <button class="icon-btn" id="lockBtn" onclick="toggleLockModal()">üîì</button>
            <button class="icon-btn" id="themeBtn" onclick="toggleTheme()">‚òÄÔ∏è</button>
        </div>
    </header>

    <div class="controls-area">
        <input type="text" id="playerName" placeholder="Enter Player Name">
        <button onclick="addPlayer()">+ Add Player</button>
        <button class="secondary" onclick="copyLink()">üîó Share</button>
        <button class="danger" onclick="archiveAndReset()">üèÜ Finish</button>
    </div>

    <div class="room-info" style="text-align:center; margin-bottom:10px; color:#888;">
        Room ID: <strong id="roomIdDisplay">Loading...</strong>
    </div>

    <div class="table-wrapper" id="tableWrapper">
        <table id="scoreTable">
            <thead><tr id="headerRow"><th class="category-col">Category</th></tr></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <div class="history-section">
        <h3>üìú History</h3>
        <div id="historyList"></div>
    </div>

    <div id="debug-console">System Log:<br></div>

    <!-- Modals -->
    <div id="ruleModal" class="modal-backdrop" onclick="if(event.target === this) this.style.display='none'">
        <div class="modal">
            <h3 id="ruleTitle">Rule</h3>
            <div id="ruleText" class="rule-desc"></div>
            <button onclick="document.getElementById('ruleModal').style.display='none'">Got it</button>
        </div>
    </div>

    <div id="pinModal" class="modal-backdrop">
        <div class="modal">
            <h3>üîí Room Locked</h3>
            <p>Please enter the PIN to edit scores.</p>
            <input type="password" id="pinInput" placeholder="Enter PIN" style="width: 100%; margin-bottom: 10px;">
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button onclick="verifyPin()">Unlock</button>
                <button class="secondary" onclick="document.getElementById('pinModal').style.display='none'">View Only</button>
            </div>
        </div>
    </div>

    <div id="setPinModal" class="modal-backdrop">
        <div class="modal">
            <h3>üîê Set Room PIN</h3>
            <p>Protect this scoreboard?</p>
            <input type="text" id="newPinInput" placeholder="Create 4-digit PIN" maxlength="4" style="width: 100%; margin-bottom: 10px;">
            <button onclick="setRoomPin()">Set Lock</button><br><br>
            <button class="secondary" style="font-size: 0.8em;" onclick="removeRoomPin()">Remove Lock</button>
            <button class="secondary" style="font-size: 0.8em;" onclick="document.getElementById('setPinModal').style.display='none'">Cancel</button>
        </div>
    </div>

    <script>
        // --- LOGGING ---
        function log(msg, type="info") {
            const c = document.getElementById('debug-console');
            if(type==='error') c.style.display = 'block';
            const line = document.createElement('div');
            line.textContent = `> ${msg}`;
            if(type==='error') line.className='log-err';
            else if(type==='success') line.className='log-ok';
            c.appendChild(line);
            console.log(msg);
        }

        // --- 1. STARTUP (No external dependencies) ---
        let gameId = window.location.hash.replace('#', '');
        if (!gameId || gameId.length < 2) {
            gameId = Math.random().toString(36).substr(2, 6);
            window.location.hash = gameId;
            log("Generated ID: " + gameId);
        } else {
            log("Found ID: " + gameId);
        }
        document.getElementById('roomIdDisplay').innerText = gameId;

        // --- 2. FIREBASE SETUP (Compat Mode) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDu86vB2-zePebM5oL_onW5E5Aiszgzh84",
            authDomain: "yatzy-eb87c.firebaseapp.com",
            databaseURL: "https://yatzy-eb87c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "yatzy-eb87c",
            storageBucket: "yatzy-eb87c.firebasestorage.app",
            messagingSenderId: "720938944178",
            appId: "1:720938944178:web:de183e0ca6a116b915ebab",
            measurementId: "G-6FCGWX4R4L"
        };

        let db;
        let playerData = {};
        let roomPin = null;
        let isAuthorized = false;
        let soundEnabled = true;

        // Wait for scripts to load, then init
        window.onload = function() {
            if (typeof firebase !== 'undefined') {
                log("Firebase Scripts Loaded", "success");
                try {
                    firebase.initializeApp(firebaseConfig);
                    db = firebase.database();
                    log("Firebase Initialized. Connecting...");
                    setupListeners();
                } catch (e) {
                    log("INIT ERROR: " + e.message, "error");
                }
            } else {
                log("CRITICAL: Firebase scripts failed to load.", "error");
                alert("Error: Check internet connection.");
            }
        };

        function setupListeners() {
            const roomRef = db.ref(`games/${gameId}`);
            roomRef.on('value', (snapshot) => {
                log("Data received", "success");
                const data = snapshot.val() || {};
                playerData = data.current?.players || {};
                roomPin = data.settings?.pin || null;
                
                document.getElementById('lockBtn').innerText = roomPin ? 'üîí' : 'üîì';
                document.getElementById('statusDot').classList.add('online');
                renderTable();
            }, (err) => {
                log("DB Error: " + err.message, "error");
            });

            db.ref(`games/${gameId}/history`).on('value', (snap) => renderHistory(snap.val()));
        }

        // --- LOGIC ---
        const RULES={ones:5,twos:10,threes:15,fours:20,fives:25,sixes:30,pair:12,twoPair:22,threeKind:30,fourKind:30,smallStr:30,largeStr:40,fullHouse:28,chance:30,yatzy:50};
        const CATEGORIES=[
            {id:'ones',label:'Ones',rule:'Sum of ones. Max 5.'},
            {id:'twos',label:'Twos',rule:'Sum of twos. Max 10.'},
            {id:'threes',label:'Threes',rule:'Sum of threes. Max 15.'},
            {id:'fours',label:'Fours',rule:'Sum of fours. Max 20.'},
            {id:'fives',label:'Fives',rule:'Sum of fives. Max 25.'},
            {id:'sixes',label:'Sixes',rule:'Sum of sixes. Max 30.'},
            {id:'sum',label:'Sum',type:'calc'},
            {id:'bonus',label:'Bonus',type:'calc',rule:'If Sum ‚â• 63, score 50.'},
            {id:'pair',label:'One Pair',rule:'Sum of two same dice.'},
            {id:'twoPair',label:'Two Pairs',rule:'Sum of two different pairs.'},
            {id:'threeKind',label:'3 of a Kind',rule:'Sum of three same dice.'},
            {id:'fourKind',label:'4 of a Kind',rule:'Sum of four same dice.'},
            {id:'smallStr',label:'Small Str.',rule:'Seq of 4. Score 15 or 30.'},
            {id:'largeStr',label:'Large Str.',rule:'Seq of 5. Score 20 or 40.'},
            {id:'fullHouse',label:'Full House',rule:'3 of one + 2 of another.'},
            {id:'chance',label:'Chance',rule:'Sum of all 5 dice.'},
            {id:'yatzy',label:'Yatzy',rule:'All 5 same. 50 or 0.'},
            {id:'total',label:'TOTAL',type:'calc'}
        ];

        // Global functions for buttons
        window.addPlayer = function() {
            if(!checkAuth()) return;
            const name = document.getElementById('playerName').value.trim();
            if(!name) return;
            Sound.tap();
            db.ref(`games/${gameId}/current/players/p_${Date.now()}`).update({ name: name, scores: {} });
            document.getElementById('playerName').value = '';
        };

        window.updateScore = function(pid, cat, val) {
            if(!checkAuth()) { renderTable(); return; }
            const num = Number(val);
            let err = "";
            if(val!=='') {
                if(isNaN(num)||num<0) err="Positive only";
                else if(RULES[cat] && num>RULES[cat]) err=`Max is ${RULES[cat]}`;
                else if(cat==='yatzy' && num!==0 && num!==50) err="50 or 0";
            }
            if(err) {
                Sound.error(); alert(err); 
                const el = document.querySelector(`input[data-pid="${pid}"][data-cat="${cat}"]`);
                if(el) { el.classList.add('invalid-shake'); setTimeout(()=>el.classList.remove('invalid-shake'),500); }
                renderTable(); return;
            }
            if(val!=='') { (cat==='yatzy'&&num===50)?(Sound.yatzy(),startConfetti()):Sound.score(); }
            
            db.ref(`games/${gameId}/current/players/${pid}/scores/${cat}`).set(val===''?null:num);
        };

        window.archiveAndReset = function() {
            if(!checkAuth()) return;
            const pList = playerData ? Object.values(playerData) : [];
            if(!pList.length) return alert("No players");
            
            let winner="None", max=-1, results=[];
            pList.forEach(p => {
                let s = calculateTotal(p.scores||{});
                results.push({name:p.name, score:s});
                if(s>max) { max=s; winner=p.name; }
            });

            if(!confirm(`Finish game?\nWinner: ${winner} (${max})`)) return;
            try{Sound.fanfare();startConfetti();}catch(e){}
            
            db.ref(`games/${gameId}/history`).push({ date: new Date().toISOString(), winner: winner, results: results });
            
            const updates={};
            Object.keys(playerData).forEach(pid => updates[`players/${pid}/scores`] = null);
            db.ref(`games/${gameId}/current`).update(updates);
            setTimeout(()=>alert(`üèÜ WINNER: ${winner} üèÜ`), 300);
        };

        // --- RENDER & HELPERS ---
        function renderTable() {
            const hRow = document.getElementById('headerRow');
            const tbody = document.getElementById('tableBody');
            while(hRow.children.length > 1) hRow.removeChild(hRow.lastChild);
            
            const pids = Object.keys(playerData).sort();
            pids.forEach(pid => {
                const th = document.createElement('th');
                th.innerText = playerData[pid].name;
                hRow.appendChild(th);
            });

            tbody.innerHTML = '';
            CATEGORIES.forEach(cat => {
                const tr = document.createElement('tr');
                if(cat.id.includes('sum')||cat.id.includes('bonus')) tr.className='subtotal-row';
                if(cat.id==='total') tr.className='total-row';

                const tdLabel = document.createElement('td');
                tdLabel.className='category-col';
                tdLabel.innerHTML=`<span>${cat.label}</span>`;
                if(cat.rule) {
                    const i = document.createElement('span'); i.className='help-icon'; i.innerText='?';
                    i.onclick=()=>window.showRule(cat.label, cat.rule); tdLabel.appendChild(i);
                }
                tr.appendChild(tdLabel);

                pids.forEach(pid => {
                    const td = document.createElement('td');
                    const scores = playerData[pid].scores || {};
                    if(cat.type==='calc') {
                        td.innerText = calculateField(cat.id, scores);
                    } else {
                        const val = (scores[cat.id]!==undefined) ? scores[cat.id] : '';
                        const inp = document.createElement('input');
                        inp.className='score-input'; inp.type='tel'; inp.value=val; inp.placeholder='-';
                        inp.setAttribute('data-pid', pid); inp.setAttribute('data-cat', cat.id);
                        inp.onchange=(e)=>window.updateScore(pid, cat.id, e.target.value);
                        td.appendChild(inp);
                    }
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }

        function calculateField(type, s) {
            const upper = ['ones','twos','threes','fours','fives','sixes'];
            let sum=0; upper.forEach(k => sum+=Number(s[k]||0));
            if(type==='sum') return sum;
            if(type==='bonus') return sum>=63?50:0;
            if(type==='total') {
                let t=sum+(sum>=63?50:0);
                ['pair','twoPair','threeKind','fourKind','smallStr','largeStr','fullHouse','chance','yatzy']
                    .forEach(k=>t+=Number(s[k]||0));
                return t;
            }
            return 0;
        }
        function calculateTotal(s){return calculateField('total',s);}

        function renderHistory(h){
            const l=document.getElementById('historyList'); l.innerHTML=''; if(!h)return;
            Object.values(h).reverse().forEach(g=>{
                const d=document.createElement('div'); d.className='history-card';
                d.innerHTML=`<span>üèÜ <b>${g.winner}</b></span> <span>${g.results.find(r=>r.name===g.winner)?.score} pts</span> <span style="font-size:0.8em;color:#888">${new Date(g.date).toLocaleDateString()}</span>`;
                l.appendChild(d);
            });
        }

        // --- MISSING FUNCTIONS RECONSTRUCTED ---

        window.showRule = function(title, text) {
             document.getElementById('ruleTitle').innerText = title;
             document.getElementById('ruleText').innerText = text;
             document.getElementById('ruleModal').style.display = 'flex';
        };

        window.toggleSound = function() {
            soundEnabled = !soundEnabled;
            document.getElementById('soundBtn').innerText = soundEnabled ? 'üîä' : 'üîá';
        };

        window.toggleTheme = function() {
            const body = document.body;
            if (body.getAttribute('data-theme') === 'light') {
                body.removeAttribute('data-theme');
                document.getElementById('themeBtn').innerText = '‚òÄÔ∏è';
            } else {
                body.setAttribute('data-theme', 'light');
                document.getElementById('themeBtn').innerText = 'üåô';
            }
        };

        window.copyLink = function() {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => alert("Link copied!"));
        };

        window.toggleLockModal = function() {
            if (roomPin) {
                // Room is locked, show unlock modal if not authorized
                 if (isAuthorized) {
                     // Already authorized, maybe offer to remove pin? Or just show settings?
                     // For simplicity, let's show setPinModal to allow removing/changing
                     document.getElementById('newPinInput').value = '';
                     document.getElementById('setPinModal').style.display = 'flex';
                 } else {
                     document.getElementById('pinInput').value = '';
                     document.getElementById('pinModal').style.display = 'flex';
                 }
            } else {
                // Room is not locked, show set pin modal
                document.getElementById('newPinInput').value = '';
                document.getElementById('setPinModal').style.display = 'flex';
            }
        };

        window.verifyPin = function() {
            const input = document.getElementById('pinInput').value;
            if (input === roomPin) {
                isAuthorized = true;
                document.getElementById('pinModal').style.display = 'none';
                alert("Unlocked!");
            } else {
                alert("Incorrect PIN");
                Sound.error();
            }
        };

        window.setRoomPin = function() {
            const pin = document.getElementById('newPinInput').value;
            if (pin.length < 4) { alert("Min 4 digits"); return; }
            db.ref(`games/${gameId}/settings/pin`).set(pin);
            document.getElementById('setPinModal').style.display = 'none';
            isAuthorized = true; // Setter is authorized
        };

        window.removeRoomPin = function() {
             if (!roomPin) return;
             // Should verify current pin before removing? Assuming authorized.
             db.ref(`games/${gameId}/settings/pin`).remove();
             document.getElementById('setPinModal').style.display = 'none';
             isAuthorized = false; // Reset auth state?
        };

        function checkAuth() {
            if (!roomPin) return true;
            if (isAuthorized) return true;
            document.getElementById('pinInput').value = '';
            document.getElementById('pinModal').style.display = 'flex';
            return false;
        }

        const Sound = {
            tap: () => playTone(800, 'square'),
            error: () => playTone(150, 'sawtooth', 0.3),
            yatzy: () => { playTone(600,'sine',0.1); setTimeout(()=>playTone(800,'sine',0.1), 100); },
            score: () => playTone(1000, 'sine'),
            fanfare: () => { playTone(500); setTimeout(()=>playTone(700), 200); }
        };

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(freq, type='sine', dur=0.1) {
            if(!soundEnabled) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + dur);
        }

        function startConfetti() {
            // Simple confetti implementation or placeholder
            const canvas = document.getElementById('confetti');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            let particles = [];
            for(let i=0; i<100; i++) {
                particles.push({
                    x: Math.random()*canvas.width,
                    y: Math.random()*canvas.height - canvas.height,
                    color: `hsl(${Math.random()*360}, 100%, 50%)`,
                    velY: Math.random()*5 + 2,
                    velX: Math.random()*2 - 1
                });
            }

            let frame = 0;
            function loop() {
                if (frame++ > 200) { ctx.clearRect(0,0,canvas.width,canvas.height); return; } // stop after some time
                ctx.clearRect(0,0,canvas.width,canvas.height);
                particles.forEach(p => {
                    p.y += p.velY;
                    p.x += p.velX;
                    ctx.fillStyle = p.color;
                    ctx.fillRect(p.x, p.y, 5, 5);
                });
                requestAnimationFrame(loop);
            }
            loop();
        }

    </script>
</body>
</html>
